{% load i18n %}

<!-- Chat Toggle Button -->
<div class="
position-fixed
 bottom-0 end-0 m-4
 d-flex
 
 " style="z-index: 1050;">
<div 
class="border 
rounded
shadow-lg
px-3 d-flex justify-content-center align-items-center"
style="z-index: 1060; 
background-color: rgb(255, 255, 255)
;
">

    {% trans 'Need any thing ?' %}
</div>
<button 
class="btn btn-primary rounded-circle shadow-lg p-3" id="chat-toggle">
<i class="bi bi-robot fs-3"></i> 
</button>
</div>




<!-- Chat Popup -->
<div id="chat-popup" class="chat-popup card shadow-lg" style="

z-index: 1060;
display:none; width:350px; position:fixed; bottom:20px; right:20px; border-radius:12px; overflow:hidden;">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Chat</span>
    <button id="chat-close" class="btn btn-sm btn-light">&times;</button>
  </div>
  <div class="card-body" style="height:300px; overflow-y:auto;">
    <div class="d-flex justify-content-center align-items-center h-100 text-muted">
      Start chatting...
    </div>
  </div>
  <div class="card-footer">
    <form id="chat-form" method="post">
      {% csrf_token %}
      <div class="input-group">
        <input type="text" name="message" class="form-control" placeholder="Type a message..." required>
        <button type="submit" class="btn btn-primary">Send</button>
      </div>
    </form>
  </div>
</div>
<!-- END chat pop up -->

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const chatPopup = document.getElementById("chat-popup");
    const chatToggle = document.getElementById("chat-toggle");
    const chatClose = document.getElementById("chat-close");
    const chatForm = document.getElementById("chat-form");
    const chatBody = chatPopup.querySelector(".card-body");

    // Open chat
    chatToggle.addEventListener("click", () => chatPopup.style.display = "block");

    // Close chat
    chatClose.addEventListener("click", () => chatPopup.style.display = "none");

    // Add message bubble
    function addMessage(text, sender="user") {
      const msg = document.createElement("div");
      msg.className = "mb-2 d-flex";
      if (sender === "user") {
        msg.classList.add("justify-content-end");
        msg.innerHTML = `<div class="p-2 rounded bg-primary text-white" style="max-width:70%;">${text}</div>`;
      } else {
        msg.classList.add("justify-content-start");
        msg.innerHTML = `<div class="p-2 rounded bg-secondary text-white" style="max-width:70%;">${text}</div>`;
      }
      chatBody.appendChild(msg);
      chatBody.scrollTop = chatBody.scrollHeight; // auto-scroll
    }

    // Handle form submit
    chatForm.addEventListener("submit", async function(e) {
      e.preventDefault();
      const input = chatForm.querySelector("input[name='message']");
      const text = input.value.trim();
      if (!text) return;

      // show user message
      addMessage(text, "user");
      input.value = "";

      try {
        const response = await fetch("{% url 'website:chatbot-ask' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),  // send csrf
          },
          body: JSON.stringify({ message: text })
        });
        const data = await response.json();
        addMessage(data.answer || "⚠️ No reply", "bot");
      } catch (err) {
        addMessage("⚠️ Error contacting server", "bot");
      }
    });

    // CSRF helper
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
          cookie = cookie.trim();
          if (cookie.startsWith(name + "=")) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  });
</script>
